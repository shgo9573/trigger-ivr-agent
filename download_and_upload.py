import os
import tempfile
import json
import yt_dlp
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

# מזהה התיקייה בגוגל דרייב אליה יועלו הקבצים
DRIVE_FOLDER_ID = "1YQyaFzviICv8F-iiSjE9Sd6PrGzpBPXs"

# תוכן קובץ העוגיות שלך נשאר כאן
cookies_content = """# Netscape HTTP Cookie File
# http://curl.haxx.se/rfc/cookie_spec.html
# This file was generated by EditThisCookie
.youtube.com\tTRUE\t/\tTRUE\t1797644928\t__Secure-1PAPISID\tXpMNUPY3FRqnSNvL/AVR3YWvmrB8Kex1db
.youtube.com\tTRUE\t/\tTRUE\t1797644928\t__Secure-1PSID\tg.a0003giQjh_4mKIdDIEhwlZJ-b7XrTbRvkxcfpRruKDne-tD1cDjJ25s8H8SDmnc9pGLOrrPsQACgYKAV8SARISFQHGX2MiHY-rr62GyKLehLfvU8JZ8hoVAUF8yKp4jUVnpSkIcX4UoodCXD5c0076
.youtube.com\tTRUE\t/\tTRUE\t1794620966\t__Secure-1PSIDCC\tAKEyXzW3KRlqFLCCqyimc17BQjAb2qShIGDug84vHIAFemDkr-Z-kaF2bow-6xF06_MDTD2g\n.youtube.com\tTRUE\t/\tTRUE\t1794620928\t__Secure-1PSIDTS\tsidts-CjUBwQ9iIxanqNWY6a74PNftJd4Qkrkn51p9TVPfjd7W8HHei9wyxnVj6_WnJSZ5Wd3UXodGKhAA\n.youtube.com\tTRUE\t/\tTRUE\t1797644928\t__Secure-3PAPISID\tXpMNUPY3FRqnSNvL/AVR3YWvmrB8Kex1db\n.youtube.com\tTRUE\t/\tTRUE\t1797644928\t__Secure-3PSID\tg.a0003giQjh_4mKIdDIEhwlZJ-b7XrTbRvkxcfpRruKDne-tD1cDjaPQ8Fv-AHUlNfFQtOi-ghgACgYKAeoSARISFQHGX2MivCXmucJci0qn8FnFov-V_hoVAUF8yKq8wnGK2zial0f7wSJZTqcU0076\n.youtube.com\tTRUE\t/\tTRUE\t1794620966\t__Secure-3PSIDCC\tAKEyXzW-2yAc9gMU1KgFF_EpJTG2YHKWD3WsQK-ptBVN7SucgaFgXUJSNuIJnA0c3XRGkQGI\n.youtube.com\tTRUE\t/\tTRUE\t1794620928\t__Secure-3PSIDTS\tsidts-CjUBwQ9iIxanqNWY6a74PNftJd4Qkrkn51p9TVPfjd7W8HHei9wyxnVj6_WnJSZ5Wd3UXodGKhAA\n.youtube.com\tTRUE\t/\tFALSE\t1797644928\tAPISID\tVldhycZGBnXCbHB_/AhpDg30ZZnfGFNAp3\n.youtube.com\tTRUE\t/\tFALSE\t1797644928\tHSID\tABIpRz9pNG4TMUc7D\n.youtube.com\tTRUE\t/\tTRUE\t1797644928\tLOGIN_INFO\tAFmmF2swRQIgGPHNUU2KNq77syeArbaI546cAzrfGp_ov4JLviWFwBkCIQCVVzmf6x22kQ6lN9_uw1fmqDCg34P2o9-9Vr8mWRq_eQ:QUQ3MjNmekFxdFk5dzB2dmRyNV80VkQ3YnlGOVpXTENQTkFjYjE5ajZHZVQxNHVaaEpnSl9LMTZmSWdsRFlvZG0yTVo3amdLQVZLaXIya0ZSQy10c0tFMllUbGt3VGJhSEstWFZtaVZ1ZW1CV3U3dGo3d3pwdEtpNHBVT1A5TGZBVlJHcVl0bVdyd0NoR0NuejNSRERwRjZHT1R0Z1hZSFR3\n.youtube.com\tTRUE\t/\tTRUE\t1797644936\tPREF\ttz=Asia.Jerusalem&f4=4000000\n.youtube.com\tTRUE\t/\tTRUE\t1797644928\tSAPISID\tXpMNUPY3FRqnSNvL/AVR3YWvmrB8Kex1db\n.youtube.com\tTRUE\t/\tFALSE\t1797644928\tSID\tg.a0003giQjh_4mKIdDIEhwlZJ-b7XrTbRvkxcfpRruKDne-tD1cDjGHmyKe2pL0r-54Hb4o_EIgACgYKAbQSARISFQHGX2MiDTffB-VYUXtbmmll_V7CTxoVAUF8yKogFU5vg841ku_b8-5dCypr0076\n.youtube.com\tTRUE\t/\tFALSE\t1794620966\tSIDCC\tAKEyXzUStBon6ZBjP5rSfrIO3uF6QL0N-gPsbg5NdrelXSk7Bw4Pd2bopZy59GqzH7EnI1BP3g\n.youtube.com\tTRUE\t/\tTRUE\t1797644928\tSSID\tAlKp-u91aDiVFxyAO\n"""

def upload_to_drive(filename):\n    """מעלה קובץ לתיקיית גוגל דרייב ספציפית"""\n    if not filename or not os.path.exists(filename):\n        print(f"הקובץ לא נמצא: {filename}")\n        return\n        
    try:\n        # טוען את פרטי ההתחברות מתוך משתנה הסביבה (Secret)\n        service_account_info = json.loads(os.getenv("GOOGLE_SERVICE_ACCOUNT"))\n        creds = service_account.Credentials.from_service_account_info(\n            service_account_info,\n            scopes=['https://www.googleapis.com/auth/drive.file']\n        )\n        service = build('drive', 'v3', credentials=creds)\n        \n        file_metadata = {\n            'name': os.path.basename(filename),\n            'parents': [DRIVE_FOLDER_ID]\n        }\n        media = MediaFileUpload(filename)\n        \n        file = service.files().create(\n            body=file_metadata,\n            media_body=media,\n            fields='id'\n        ).execute()\n        \n        print(f"העלאה לדרייב הצליחה. File ID: {file.get('id')}")\n    except Exception as e:\n        print(f"אירעה שגיאה במהלך ההעלאה ל-Google Drive: {e}")\n\n\ndef download_media(video_url, format_choice):\n    """מוריד מדיה מהקישור הנתון באמצעות yt-dlp"""\n    cookie_file_path = None\n    downloaded_file = None\n    try:\n        # יוצר קובץ עוגיות זמני\n        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.txt', encoding='utf-8') as temp_cookie_file:\n            temp_cookie_file.write(cookies_content)\n            cookie_file_path = temp_cookie_file.name\n\n        ydl_opts = {\n            'outtmpl': '%(title)s.%(ext)s',\n            'cookiefile': cookie_file_path,\n            'noplaylist': True,\n        }\n\n        if format_choice == 'mp3':\n            ydl_opts['format'] = 'bestaudio/best' # הורדת זרם האודיו הטוב ביותר\n            ydl_opts['postprocessors'] = [{\n                'key': 'FFmpegExtractAudio',\n                'preferredcodec': 'mp3',\n                'preferredquality': '192',\n            }]\n        elif format_choice == 'mp4':\n            ydl_opts['format'] = 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best'\n        else:\n            print(f"פורמט לא נתמך: {format_choice}. מוריד כ-MP4 כברירת מחדל.")\n            ydl_opts['format'] = 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best'\n\n        with yt_dlp.YoutubeDL(ydl_opts) as ydl:\n            info = ydl.extract_info(video_url, download=True)\n            downloaded_file = ydl.prepare_filename(info)\n            print(f"ההורדה הצליחה: {downloaded_file}")\n            return downloaded_file\n\n    except yt_dlp.utils.DownloadError as e:\n        print(f"שגיאת הורדה מ-yt-dlp: {e}")\n    except Exception as e:\n        print(f"אירעה שגיאה בלתי צפויה במהלך ההורדה: {e}")\n    finally:\n        # מנקה את קובץ העוגיות הזמני\n        if cookie_file_path and os.path.exists(cookie_file_path):\n            os.remove(cookie_file_path)\n    return None\n\n\nif __name__ == \"__main__\":\n    try:\n        with open(\"link.txt\", \"r\") as f:\n            video_url = f.read().strip()\n        with open(\"format.txt\", \"r\") as f:\n            format_choice = f.read().strip()\n        \n        if not video_url:\n            print(\"\u05d4\u05e7\u05d5\u05d1\u05e5 link.txt \u05e8\u05d9\u05e7. \u05d4\u05ea\u05d4\u05dc\u05d9\u05da \u05e0\u05e2\u05e6\u05e8.\")\n        else:\n            print(f\"\u05de\u05ea\u05d7\u05d9\u05dc \u05d4\u05d5\u05e8\u05d3\u05d4 \u05e2\u05d1\u05d5\u05e8 \u05d4\u05e7\u05d9\u05e9\u05d5\u05e8: {video_url} \u05d1\u05e4\u05d5\u05e8\u05de\u05d8: {format_choice}\")\n            downloaded_filename = download_media(video_url, format_choice)\n            \n            if downloaded_filename and os.path.exists(downloaded_filename):\n                print(f\"\u05de\u05ea\u05d7\u05d9\u05dc \u05d4\u05e2\u05dc\u05d0\u05d4 \u05e9\u05dc '{downloaded_filename}' \u05dc-Google Drive.\")\n                upload_to_drive(downloaded_filename)\n                \n                # \u05de\u05e0\u05e7\u05d4 \u05d0\u05ea \u05d4\u05e7\u05d5\u05d1\u05e5 \u05e9\u05d4\u05d5\u05e8\u05d3 \u05de\u05d4\u05e9\u05e8\u05ea\n                os.remove(downloaded_filename)\n                print(f\"\u05d4\u05e7\u05d5\u05d1\u05e5 \u05d4\u05de\u05e7\u05d5\u05de\u05d9 \u05e0\u05de\u05d7\u05e7: {downloaded_filename}\")\n            else:\n                print(\"\u05d4\u05d4\u05d5\u05e8\u05d3\u05d4 \u05e0\u05db\u05e9\u05dc\u05d4, \u05de\u05d3\u05dc\u05d2 \u05e2\u05dc \u05e9\u05dc\u05d1 \u05d4\u05d4\u05e2\u05dc\u05d0\u05d4.\")\n\n    except FileNotFoundError:\n        print(\"\u05e7\u05d5\u05d1\u05e5 link.txt \u05d0\u05d5 format.txt \u05dc\u05d0 \u05e0\u05de\u05e6\u05d0.\")\n    except Exception as e:\n        print(f\"\u05d0\u05d9\u05e8\u05e2\u05d4 \u05e9\u05d2\u05d9\u05d0\u05d4 \u05d1\u05ea\u05d4\u05dc\u05d9\u05da \u05d4\u05e8\u05d0\u05e9\u05d9: {e}\")\n"}